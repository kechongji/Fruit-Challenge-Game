<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±å¯¶ä¼Šç”¸åœ’-èŠ±é–‹ç¾æœé—–é—œéŠæˆ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #111827;
            color: white;
            overflow: hidden;
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿæ»‘å‹• */
        }
        #game-container {
            position: relative;
            width: 100%;
            max-width: 960px;
            aspect-ratio: 16/9;
            margin: 0 auto;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 100%);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border-radius: 10px;
            overflow: hidden;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        .overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .hidden { display: none !important; }
        
        /* éŠæˆ²å…§ UI å±¤ */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; right: 0;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ° canvas */
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
            font-weight: 900;
            font-size: 1.2rem;
            z-index: 5;
        }
        
        /* æ‰‹æ©Ÿè™›æ“¬æŒ‰éµ */
        #mobile-controls {
            position: absolute;
            bottom: 20px; left: 0; right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 5;
        }
        .btn-control {
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid white;
            border-radius: 50%;
            width: 60px; height: 60px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; user-select: none;
            backdrop-filter: blur(5px);
        }
        .btn-control:active { background: rgba(255, 255, 255, 0.6); }
        
        @media (min-width: 768px) {
            #mobile-controls { display: none; }
        }

        /* å‹•ç•« */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .animate-pulse-fast { animation: pulse 1.5s infinite; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen m-0 p-4">

    <div id="game-container">
        <!-- ç•«å¸ƒ -->
        <canvas id="gameCanvas" width="960" height="540"></canvas>

        <!-- éŠæˆ²ç‹€æ…‹ UI -->
        <div id="ui-layer" class="hidden text-white w-full h-full pointer-events-none">
            <!-- å·¦å´è³‡è¨Š -->
            <div class="flex flex-col gap-1">
                <div class="flex items-center gap-2">
                    <span class="text-red-400">ç”Ÿå‘½:</span>
                    <div class="w-32 h-4 bg-gray-700 rounded-full overflow-hidden border border-gray-600">
                        <div id="ui-health-bar" class="h-full bg-green-500 transition-all duration-300" style="width: 100%;"></div>
                    </div>
                    <span id="ui-health-text" class="text-sm text-gray-300 font-normal">30/30</span>
                </div>
                <div class="text-yellow-300">ç¸½åˆ†: <span id="ui-score">0</span></div>
                <div class="text-blue-300" id="ui-ammo-container">å­å½ˆ: <span id="ui-ammo">0</span></div>
                <div class="text-purple-300 hidden" id="ui-fly-container">é£›è¡Œ: <span id="ui-fly-time">0</span>s</div>
                <div class="text-white mt-1">æ™‚é–“: <span id="ui-time">100</span>s</div>
                <div class="text-sm text-gray-200" id="ui-goal">ç›®æ¨™: 100åˆ†é–‹å•Ÿçµ‚é»</div>
            </div>
            
            <!-- å³ä¸Šè§’ éŠæˆ² Logo (é®®è±” + å¢æ—é‡ç¸æ’åœ–) -->
            <div class="flex flex-col items-end opacity-100 mt-2 mr-4 pointer-events-auto transition-transform hover:scale-105" style="font-family: 'ZCOOL KuaiLe', cursive;">
                <div class="relative flex items-center">
                    <!-- å¢æ—èˆ‡é‡ç¸æ’åœ– (Emoji çµåˆ CSS é™°å½±) -->
                    <span class="absolute -left-6 -top-2 text-2xl drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)] z-0">ğŸŒ´</span>
                    <span class="absolute -left-2 -bottom-2 text-xl drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)] z-20">ğŸŒ¿</span>
                    <span class="absolute -right-4 -top-3 text-2xl drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)] z-0 transform rotate-12">ğŸ¯</span>

                    <!-- é®®è±”çš„ä¸»æ¨™é¡Œ (ä¿®æ­£æ¼¸å±¤èˆ‡æé‚Šè¡çªå•é¡Œï¼Œä½¿ç”¨ç´”è‰²+å¤šé‡é™°å½±) -->
                    <div class="text-2xl md:text-3xl tracking-widest relative z-10" style="color: #FF3399; text-shadow: -2px -2px 0 #FFF, 2px -2px 0 #FFF, -2px 2px 0 #FFF, 2px 2px 0 #FFF, 0px 4px 4px rgba(0,0,0,0.8);">
                        æ±å¯¶ä¼Šç”¸åœ’
                    </div>
                </div>
                
                <div class="relative mt-2 pr-1">
                    <!-- æ›´å¤šæ’åœ– -->
                    <span class="absolute -left-4 -top-2 text-xl drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)] z-20 transform -rotate-12">ğŸ¦</span>
                    <span class="absolute -right-2 -bottom-1 text-lg drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)] z-20">ğŸŒº</span>
                    
                    <!-- é®®è±”çš„å‰¯æ¨™é¡Œ -->
                    <div class="text-[10px] md:text-xs text-white px-3 py-1 rounded-full transform -rotate-3 relative z-10 tracking-wider" style="background: linear-gradient(to right, #9933FF, #FF3366); border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.6);">
                        èŠ±é–‹ç¾æœé—–é—œéŠæˆ²
                    </div>
                </div>
            </div>
        </div>

        <!-- æ‰‹æ©Ÿæ§åˆ¶ -->
        <div id="mobile-controls" class="hidden">
            <div class="flex gap-4">
                <div class="btn-control" id="btn-left">â—€</div>
                <div class="btn-control" id="btn-right">â–¶</div>
            </div>
            <div class="flex gap-2">
                <div class="btn-control text-blue-500" id="btn-down">â–¼</div>
                <div class="btn-control text-blue-500" id="btn-up">â–²</div>
                <div class="btn-control text-red-500" id="btn-shoot">ğŸ¯</div>
            </div>
        </div>

        <!-- é–‹å§‹ç•«é¢ -->
        <div id="start-screen" class="overlay">
            <h1 class="text-4xl md:text-5xl mb-2 text-center tracking-widest" style="font-family: 'ZCOOL KuaiLe', cursive; color: #FF3399; text-shadow: -2px -2px 0 #FFF, 2px -2px 0 #FFF, -2px 2px 0 #FFF, 2px 2px 0 #FFF, 0px 5px 10px rgba(0,0,0,0.8);">æ±å¯¶ä¼Šç”¸åœ’</h1>
            <h2 class="text-xl md:text-2xl font-bold text-pink-300 mb-6 text-center">èŠ±é–‹ç¾æœé—–é—œéŠæˆ²</h2>
            
            <div class="bg-gray-800 bg-opacity-90 p-6 rounded-xl max-w-md text-sm md:text-base mb-6 shadow-2xl border border-gray-600">
                <h3 class="text-xl font-bold mb-3 text-yellow-300 border-b border-gray-600 pb-2">éŠæˆ²èªªæ˜</h3>
                <ul class="list-disc pl-5 space-y-2 text-gray-200">
                    <li><b>æ§åˆ¶:</b> [â†‘][â†“] è·³èº/é£›è¡Œ, [â†][â†’] ç§»å‹•, [ç©ºç™½éµ] å°„æ“Š</li>
                    <li>ğŸ¥­ğŸ’ğŸ‹ <b>æ±å¯¶ç¾ç”¢æ°´æœ:</b> ç”Ÿå‘½ +10, åˆ†æ•¸ +30</li>
                    <li>ğŸ‘¼ <b>å¤©ä½¿é™è‡¨:</b> å¤©ä½¿æœƒåœ¨ç©ºä¸­é£›è¡Œï¼Œä¸¦éš¨æ©ŸæŠ•ä¸‹ç¥è–çš„æ°´æœï¼</li>
                    <li>ğŸ”« <b>æ§æ:</b> ç²å¾— 20 ç™¼å­å½ˆ, åˆ†æ•¸ +10</li>
                    <li>ğŸ§¹ <b>é­”æ³•æƒæŠŠ:</b> ç²å¾— 10 ç§’é£›è¡Œèƒ½åŠ› (æ–¹å‘éµè‡ªç”±ç§»å‹•)</li>
                    <li>ğŸ”ğŸŸğŸ¥¤ <b>æ¸›å°‘é£Ÿç”¨:</b> ç”Ÿå‘½ -5, åˆ†æ•¸ -15 (éœ€ 3 ç™¼å­å½ˆæ¶ˆæ»…)</li>
                    <li>ğŸ›ğŸ¦–ğŸ‘½ <b>æ€ªç‰©:</b> ç”Ÿå‘½ -10, åˆ†æ•¸ -20 (éœ€ 5 ç™¼å­å½ˆæ¶ˆæ»…)</li>
                    <li>ğŸ›¸ <b>é£›ç¢Ÿå±æ©Ÿ:</b> åˆ†æ•¸é”50åˆ†æœƒå‡ºç¾1å°é£›ç¢ŸæŠ•æ“²ç‚¸å½ˆğŸ’£ï¼è¢«ç‚¸ç›´æ¥æ­¸é›¶ï¼</li>
                    <li><b>å¤±æ•—æ¢ä»¶:</b> ç”Ÿå‘½ç·š â‰¤ 0 æˆ– 100ç§’ æ™‚é–“å€’æ•¸çµæŸ</li>
                </ul>
            </div>

            <input type="text" id="player-name" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" class="px-4 py-3 rounded-lg text-black font-bold mb-4 text-center w-64 focus:outline-none focus:ring-4 focus:ring-green-500" maxlength="10">
            
            <button id="start-btn" class="px-8 py-3 bg-gradient-to-r from-green-400 to-blue-500 hover:from-green-500 hover:to-blue-600 text-white font-bold rounded-full text-xl shadow-lg transform transition hover:scale-105 animate-pulse-fast">
                é–‹å§‹éŠæˆ²
            </button>
        </div>

        <!-- çµæŸ/éé—œç•«é¢ -->
        <div id="end-screen" class="overlay hidden">
            <h1 id="end-title" class="text-5xl font-black mb-2 text-center"></h1>
            <p id="end-msg" class="text-xl text-gray-300 mb-6"></p>
            
            <div class="bg-gray-800 p-6 rounded-xl mb-6 border border-gray-600 shadow-2xl min-w-[300px]">
                <h3 class="text-2xl font-bold text-yellow-400 mb-4 text-center">è‹±é›„æ¦œ</h3>
                <ol id="leaderboard" class="space-y-2 text-lg"></ol>
            </div>

            <button id="restart-btn" class="px-8 py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-full text-xl shadow-lg transform transition hover:scale-105">
                é‡æ–°é–‹å§‹
            </button>
        </div>
    </div>

    <script>
        // --- éŠæˆ²éŸ³æ•ˆç³»çµ± (ä½¿ç”¨ Web Audio API åˆæˆï¼Œå…è¼‰å…¥å¤–éƒ¨æª”æ¡ˆ) ---
        class AudioSystem {
            constructor() {
                this.ctx = null;
                this.enabled = false;
            }
            init() {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
                this.enabled = true;
            }
            playTone(freq, type, duration, vol=0.1) {
                if (!this.enabled) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            }
            jump() { this.playTone(400, 'sine', 0.3, 0.1); setTimeout(() => this.playTone(600, 'sine', 0.2, 0.1), 50); }
            shoot() { this.playTone(800, 'square', 0.1, 0.05); }
            eatFruit() { this.playTone(880, 'sine', 0.1, 0.1); setTimeout(() => this.playTone(1100, 'sine', 0.2, 0.1), 100); }
            getGun() { this.playTone(440, 'triangle', 0.1, 0.1); setTimeout(() => this.playTone(660, 'triangle', 0.3, 0.1), 100); }
            hurt() { this.playTone(150, 'sawtooth', 0.4, 0.2); }
            hitEnemy() { this.playTone(200, 'square', 0.1, 0.1); }
            firework() { 
                this.playTone(600 + Math.random()*400, 'sine', 0.1, 0.1); 
                setTimeout(() => this.playTone(200, 'sawtooth', 0.3, 0.1), 100); 
            }
            win() { 
                [523, 659, 783, 1046].forEach((f, i) => {
                    setTimeout(() => this.playTone(f, 'sine', 0.3, 0.15), i * 150);
                });
            }
            lose() {
                [300, 250, 200, 150].forEach((f, i) => {
                    setTimeout(() => this.playTone(f, 'sawtooth', 0.4, 0.2), i * 300);
                });
            }
        }
        const audio = new AudioSystem();

        // --- æ’è¡Œæ¦œç³»çµ± (localStorage) ---
        const Leaderboard = {
            save: function(name, score) {
                let board = JSON.parse(localStorage.getItem('dongbao_leaderboard') || '[]');
                board.push({name: name || 'ç„¡åè‹±é›„', score: score});
                board.sort((a, b) => b.score - a.score);
                board = board.slice(0, 5); // åªä¿ç•™å‰äº”å
                localStorage.setItem('dongbao_leaderboard', JSON.stringify(board));
            },
            getHTML: function() {
                let board = JSON.parse(localStorage.getItem('dongbao_leaderboard') || '[]');
                if(board.length === 0) return "<li class='text-gray-400 text-center'>å°šç„¡ç´€éŒ„</li>";
                return board.map((entry, i) => 
                    `<li class="flex justify-between border-b border-gray-700 pb-1">
                        <span><span class="text-gray-400 w-6 inline-block">${i+1}.</span> ${entry.name}</span>
                        <span class="text-yellow-400 font-bold">${entry.score} åˆ†</span>
                    </li>`
                ).join('');
            }
        };

        // --- éŠæˆ²å¼•æ“èˆ‡é‚è¼¯ ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // UI å…ƒç´ 
        const startScreen = document.getElementById('start-screen');
        const endScreen = document.getElementById('end-screen');
        const uiLayer = document.getElementById('ui-layer');
        const mobileControls = document.getElementById('mobile-controls');
        
        // éŠæˆ²å¸¸æ•¸
        const GRAVITY = 1500;
        const JUMP_FORCE = -650;
        const PLAYER_SPEED = 350;
        const MAX_HEALTH = 30;
        const TIME_LIMIT = 100;
        
        // æŒ‰éµè¿½è¹¤
        const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false, Space: false };

        class Game {
            constructor(playerName) {
                this.playerName = playerName;
                this.state = 'playing'; // playing, win, lose
                this.lastTime = performance.now();
                
                // ç©å®¶ç‹€æ…‹
                this.player = {
                    x: 100, y: 300, width: 40, height: 60,
                    vx: 0, vy: 0, isGrounded: false,
                    health: MAX_HEALTH, score: 0, ammo: 0,
                    lastShootTime: 0, dir: 1,
                    isFlying: false, flyTimer: 0
                };
                
                this.camera = { x: 0 };
                this.timeLeft = TIME_LIMIT;
                this.lastSecond = performance.now();
                
                this.platforms = [];
                this.entities = []; // æ°´æœ, åƒåœ¾, æ€ªç‰©, æ§, æ——å­
                this.bullets = [];
                this.particles = [];
                this.bombs = []; // å„²å­˜ç‚¸å½ˆ
                this.ufos = []; // æ”¹ç‚ºé™£åˆ—ä»¥æ”¯æ´å¤šå°é£›ç¢Ÿ
                
                // å¤©ä½¿èˆ‡ç©ºæŠ•æ°´æœæ©Ÿåˆ¶
                this.angels = [];
                this.fallingFruits = [];
                this.angelSpawnTimer = 1 + Math.random() * 4; // é–‹å±€ 1~5 ç§’å¾Œå‡ºç¾ç¬¬ä¸€éš»å¤©ä½¿
                
                this.flagSpawned = false;
                this.furthestX = 0; // ç”¨æ–¼ç¨‹åºåŒ–ç”Ÿæˆé—œå¡

                // åˆå§‹åœ°æ¿
                this.platforms.push({ x: -1000, y: 480, w: 3000, h: 60 });
                this.generateLevelChunks(1500);

                this.bindControls();
                this.updateUI();
                
                requestAnimationFrame((t) => this.loop(t));
            }

            generateLevelChunks(targetX) {
                while (this.furthestX < targetX) {
                    let startX = this.furthestX + 100 + Math.random() * 200;
                    let width = 100 + Math.random() * 300;
                    let y = 350 + Math.random() * 100; // é«˜ä½ä¸å¹³çš„å¹³å°
                    
                    this.platforms.push({ x: startX, y: y, w: width, h: 30 });
                    
                    // åœ¨å¹³å°ä¸Šéš¨æ©Ÿç”Ÿæˆæ±è¥¿
                    if (Math.random() > 0.3) {
                        let entityType = Math.random();
                        let ex = startX + width / 2;
                        let ey = y - 40;
                        
                        if (entityType < 0.3) {
                            const fruits = ['ğŸ¥­', 'ğŸ’', 'ğŸ‹'];
                            const randomFruit = fruits[Math.floor(Math.random() * fruits.length)];
                            this.entities.push({ type: 'fruit', x: ex, y: ey, w: 30, h: 30, emoji: randomFruit });
                        } else if (entityType < 0.6) {
                            const junks = ['ğŸ”', 'ğŸŸ', 'ğŸ—', 'ğŸ¥¤', 'ğŸ§‹'];
                            const randomJunk = junks[Math.floor(Math.random() * junks.length)];
                            this.entities.push({ type: 'junk', x: ex, y: ey, w: 40, h: 40, emoji: randomJunk, hp: 3 });
                        } else if (entityType < 0.8) {
                            const monsters = ['ğŸ›', 'ğŸ¦–', 'ğŸ‘½'];
                            const randomMonster = monsters[Math.floor(Math.random() * monsters.length)];
                            this.entities.push({ type: 'monster', x: ex, y: ey, w: 50, h: 50, emoji: randomMonster, hp: 5, vx: -50 });
                        } else if (entityType < 0.9) {
                            this.entities.push({ type: 'gun', x: ex, y: ey, w: 35, h: 35, emoji: 'ğŸ”«' });
                        } else {
                            this.entities.push({ type: 'broom', x: ex, y: ey, w: 40, h: 40, emoji: 'ğŸ§¹' });
                        }
                    }
                    
                    // å¡«è£œä¸‹æ–¹åœ°æ¿é¿å…ä¸€ç›´æ‘”æ­» (ä½†æœ‰æ™‚æœƒæœ‰å‘)
                    if (Math.random() > 0.2) {
                        this.platforms.push({ x: startX - 50, y: 480, w: width + 200, h: 60 });
                    }

                    this.furthestX = startX + width;
                }
            }

            bindControls() {
                // éµç›¤
                this.keydownHandler = (e) => {
                    if(e.code === 'ArrowUp') keys.ArrowUp = true;
                    if(e.code === 'ArrowDown') keys.ArrowDown = true;
                    if(e.code === 'ArrowLeft') keys.ArrowLeft = true;
                    if(e.code === 'ArrowRight') keys.ArrowRight = true;
                    if(e.code === 'Space') keys.Space = true;
                };
                this.keyupHandler = (e) => {
                    if(e.code === 'ArrowUp') keys.ArrowUp = false;
                    if(e.code === 'ArrowDown') keys.ArrowDown = false;
                    if(e.code === 'ArrowLeft') keys.ArrowLeft = false;
                    if(e.code === 'ArrowRight') keys.ArrowRight = false;
                    if(e.code === 'Space') keys.Space = false;
                };
                window.addEventListener('keydown', this.keydownHandler);
                window.addEventListener('keyup', this.keyupHandler);

                // æ‰‹æ©Ÿè§¸æ§
                const bindTouch = (id, key) => {
                    const el = document.getElementById(id);
                    if(!el) return;
                    el.ontouchstart = (e) => { e.preventDefault(); keys[key] = true; };
                    el.ontouchend = (e) => { e.preventDefault(); keys[key] = false; };
                };
                bindTouch('btn-left', 'ArrowLeft');
                bindTouch('btn-right', 'ArrowRight');
                bindTouch('btn-up', 'ArrowUp');
                bindTouch('btn-down', 'ArrowDown');
                bindTouch('btn-shoot', 'Space');
            }

            cleanup() {
                window.removeEventListener('keydown', this.keydownHandler);
                window.removeEventListener('keyup', this.keyupHandler);
                keys.ArrowUp = keys.ArrowDown = keys.ArrowLeft = keys.ArrowRight = keys.Space = false;
            }

            cleanup() {
                window.removeEventListener('keydown', this.keydownHandler);
                window.removeEventListener('keyup', this.keyupHandler);
                keys.ArrowUp = keys.ArrowLeft = keys.ArrowRight = keys.Space = false;
            }

            updateScore(amount) {
                this.player.score += amount;
                if (this.player.score < 0) this.player.score = 0;
            }

            updateHealth(amount) {
                this.player.health += amount;
                if (this.player.health > MAX_HEALTH) this.player.health = MAX_HEALTH;
                if (this.player.health <= 0) {
                    this.player.health = 0;
                    this.gameOver(false, "ç”Ÿå‘½ç·šæ­¸é›¶");
                }
            }

            shoot() {
                const now = performance.now();
                if (this.player.ammo > 0 && now - this.player.lastShootTime > 200) {
                    this.player.ammo--;
                    this.player.lastShootTime = now;
                    audio.shoot();
                    let dir = this.player.dir;

                    this.bullets.push({
                        x: this.player.x + this.player.width / 2 + (dir * 20),
                        y: this.player.y + 25,
                        w: 10, h: 4,
                        vx: dir * 800
                    });
                }
            }

            createParticles(x, y, color) {
                for(let i=0; i<5; i++) {
                    this.particles.push({
                        x, y, w: 4, h: 4,
                        vx: (Math.random()-0.5)*200,
                        vy: (Math.random()-1)*200,
                        life: 1, color: color, type: 'normal'
                    });
                }
            }

            createFirework(x, y) {
                audio.firework();
                const colors = ['#EF4444', '#3B82F6', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899', '#FEF08A'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                for(let i=0; i<40; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 150 + 50;
                    this.particles.push({
                        x: x, y: y, w: 6, h: 6,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        life: 1.5 + Math.random(),
                        color: color,
                        type: 'firework'
                    });
                }
            }

            loop(timestamp) {
                if (this.state === 'lose' || this.state === 'win') return;

                const dt = (timestamp - this.lastTime) / 1000;
                this.lastTime = timestamp;

                if (this.state === 'playing') {
                    // å€’æ•¸è¨ˆæ™‚
                    if (timestamp - this.lastSecond > 1000) {
                        this.timeLeft--;
                        this.lastSecond = timestamp;
                        if (this.timeLeft <= 0) {
                            this.gameOver(false, "æ™‚é–“åˆ°ï¼æœªé”çµ‚é»ã€‚");
                            return;
                        }
                    }

                    // --- ç‰©ç†èˆ‡è¼¸å…¥ ---
                    // æ°´å¹³ç§»å‹•
                    if (keys.ArrowLeft) {
                        this.player.vx = -PLAYER_SPEED;
                        this.player.dir = -1;
                    } else if (keys.ArrowRight) {
                        this.player.vx = PLAYER_SPEED;
                        this.player.dir = 1;
                    } else {
                        this.player.vx = 0;
                    }

                    // é­”æ³•æƒæŠŠé£›è¡Œç‹€æ…‹
                    if (this.player.isFlying) {
                        this.player.flyTimer -= dt;
                        if (this.player.flyTimer <= 0) {
                            this.player.isFlying = false;
                        }
                        
                        // å‚ç›´ç§»å‹• (ç„¡é‡åŠ›)
                        if (keys.ArrowUp) {
                            this.player.vy = -PLAYER_SPEED;
                        } else if (keys.ArrowDown) {
                            this.player.vy = PLAYER_SPEED;
                        } else {
                            this.player.vy = 0; 
                        }
                    } else {
                        // æ­£å¸¸è·³èº
                        if (keys.ArrowUp && this.player.isGrounded) {
                            this.player.vy = JUMP_FORCE;
                            this.player.isGrounded = false;
                            audio.jump();
                            keys.ArrowUp = false; // é¿å…é€£è·³
                        }
                    }

                    // å°„æ“Š
                    if (keys.Space) {
                        this.shoot();
                        keys.Space = false; // å–®ç™¼
                    }
                } else {
                    // win_anim ç‹€æ…‹ä¸‹åœæ­¢ç©å®¶è¼¸å…¥
                    this.player.vx = 0;
                }

                // å¥—ç”¨é‡åŠ› (åƒ…é™éé£›è¡Œç‹€æ…‹)
                if (!this.player.isFlying) {
                    this.player.vy += GRAVITY * dt;
                }

                // é è¨ˆç§»å‹•ä½ç½®
                let nextX = this.player.x + this.player.vx * dt;
                let nextY = this.player.y + this.player.vy * dt;

                // é‚Šç•Œé™åˆ¶ (ä¸èƒ½å¾€å·¦èµ°å‡ºç•«é¢ï¼Œä¹Ÿä¸èƒ½é£›å‡ºé ‚éƒ¨å¤©ç©º)
                if (nextX < this.camera.x) nextX = this.camera.x;
                if (nextY < 0) nextY = 0;

                // --- ç¢°æ’åµæ¸¬ (AABB) ---
                this.player.isGrounded = false;
                for (let plat of this.platforms) {
                    // X è»¸ç¢°æ’ (ç°¡åŒ–ç‰ˆï¼šä¸è™•ç†å´é¢æ“ å£“ï¼Œåªè™•ç†ä¸Šä¸‹ç«™ç«‹)
                    // åˆ¤æ–·ç©å®¶åœ¨ X è»¸ä¸Šèˆ‡å¹³å°é‡ç–Š
                    if (nextX < plat.x + plat.w && nextX + this.player.width > plat.x) {
                        // å¾ä¸Šæ–¹æ‰è½åˆ°å¹³å°ä¸Š
                        if (this.player.y + this.player.height <= plat.y && nextY + this.player.height >= plat.y) {
                            nextY = plat.y - this.player.height;
                            this.player.vy = 0;
                            this.player.isGrounded = true;
                        }
                        // å¾ä¸‹æ–¹é ‚åˆ°å¹³å°
                        else if (this.player.y >= plat.y + plat.h && nextY <= plat.y + plat.h) {
                            nextY = plat.y + plat.h;
                            this.player.vy = 0;
                        }
                    }
                }

                this.player.x = nextX;
                this.player.y = nextY;

                // æ‰å‡ºç•«é¢å¤–
                if (this.player.y > 600) {
                    this.gameOver(false, "æ‘”é€²äº†æ·±æ·µ");
                    return;
                }

                // --- å¤©ä½¿èˆ‡ç©ºæŠ•æ°´æœé‚è¼¯ ---
                if (this.angels.length === 0) {
                    this.angelSpawnTimer -= dt;
                    if (this.angelSpawnTimer <= 0) {
                        this.angels.push({
                            x: this.camera.x - 100, // å¾ç•«é¢å·¦é‚Šå¤–å´å‡ºç¾
                            y: 40 + Math.random() * 60, // å¤©ç©ºéš¨æ©Ÿé«˜åº¦
                            vx: 200 + Math.random() * 100, // å‘å³é£›è¡Œçš„é€Ÿåº¦
                            vy: 0,
                            dropX: this.camera.x + 150 + Math.random() * 500, // éš¨æ©Ÿåœ¨ç•«é¢ä¸­æŠ•ä¸‹æ°´æœçš„ä½ç½®
                            hasDropped: false,
                            emoji: 'ğŸ‘¼'
                        });
                    }
                }

                // æ›´æ–°å¤©ä½¿ç‹€æ…‹
                for (let i = this.angels.length - 1; i >= 0; i--) {
                    let angel = this.angels[i];
                    angel.x += angel.vx * dt;
                    angel.y += angel.vy * dt + Math.sin(timestamp * 0.01 + i) * 0.5; // ä¸Šä¸‹å¾®å¾®æµ®å‹•

                    // å¤©ä½¿åˆ°é”æŒ‡å®šä½ç½®æŠ•æ“²æ°´æœ
                    if (!angel.hasDropped && angel.x >= angel.dropX) {
                        const fruits = ['ğŸ¥­', 'ğŸ’', 'ğŸ‹'];
                        const randomFruit = fruits[Math.floor(Math.random() * fruits.length)];
                        this.fallingFruits.push({ 
                            x: angel.x, y: angel.y + 30, w: 30, h: 30, vy: 0, emoji: randomFruit 
                        });
                        angel.hasDropped = true;
                        angel.vy = -150; // æŠ•å®Œæ°´æœå¾Œå¾€ä¸Šé£›
                        angel.vx += 150; // åŠ é€Ÿé›¢é–‹ç•«é¢
                    }

                    // é£›å‡ºç•«é¢å¤–å‰‡ç§»é™¤ï¼Œä¸¦å•Ÿå‹•ä¸‹ä¸€æ¬¡å‡ºç¾çš„å€’æ•¸è¨ˆæ™‚ (1~5ç§’)
                    if (angel.x > this.camera.x + canvas.width + 100 || angel.y < -100) {
                        this.angels.splice(i, 1);
                        this.angelSpawnTimer = 1 + Math.random() * 4; // è¨­å®šä¸‹ä¸€æ¬¡å‡ºç¾é–“éš”ç‚º 1~5 ç§’
                    }
                }

                // æ›´æ–°æ‰è½çš„æ°´æœ
                for (let i = this.fallingFruits.length - 1; i >= 0; i--) {
                    let f = this.fallingFruits[i];
                    f.vy += GRAVITY * 0.25 * dt; // æ‰è½é€Ÿåº¦æ¯”ç‚¸å½ˆæ…¢ï¼Œåƒé£„ä¸‹ä¾†
                    f.y += f.vy * dt;

                    // æª¢æŸ¥èˆ‡ç©å®¶ç¢°æ’
                    if (this.isColliding(this.player, f)) {
                        audio.eatFruit();
                        this.updateHealth(10);
                        this.updateScore(30);
                        this.createParticles(f.x, f.y, '#34D399');
                        this.fallingFruits.splice(i, 1);
                        continue;
                    }

                    // æ‰åˆ°ç•«é¢å¤–ç§»é™¤
                    if (f.y > 600) {
                        this.fallingFruits.splice(i, 1);
                    }
                }

                // --- é£›ç¢Ÿèˆ‡ç‚¸å½ˆé‚è¼¯ ---
                let targetUfoCount = 0;
                if (this.player.score >= 50) targetUfoCount = 1; // 50åˆ†ä»¥ä¸Š 1å°

                // æ ¹æ“šç›®æ¨™æ•¸é‡ç”¢ç”Ÿé£›ç¢Ÿ
                while (this.ufos.length < targetUfoCount) {
                    this.ufos.push({
                        timer: 1.0 + Math.random() * 2.0,
                        x: 0,
                        y: 80,
                        offset: this.ufos.length * Math.PI // è®“é£›ç¢Ÿç§»å‹•çš„ç›¸ä½äº¤éŒ¯ï¼Œé¿å…é‡ç–Š
                    });
                }
                
                for (let i = 0; i < this.ufos.length; i++) {
                    let ufo = this.ufos[i];
                    // é£›ç¢Ÿåœ¨ç•«é¢ä¸Šæ–¹å·¦å³ç›¤æ—‹ (åŠ ä¸Š offset ç”¢ç”Ÿäº¤éŒ¯)
                    ufo.x = this.camera.x + canvas.width / 2 - 100 + Math.sin(timestamp / 600 + ufo.offset) * 350;
                    ufo.y = 80 + Math.cos(timestamp / 400 + ufo.offset) * 20;

                    ufo.timer -= dt;
                    if (ufo.timer <= 0) {
                        // æŠ•ä¸‹ç‚¸å½ˆ
                        this.bombs.push({ x: ufo.x, y: ufo.y + 30, w: 30, h: 30, vy: 0, emoji: 'ğŸ’£' });
                        ufo.timer = 1.0 + Math.random() * 2.0; // éš¨æ©Ÿ 1 ~ 3 ç§’æŠ•ä¸€é¡†
                    }
                }

                // ç‚¸å½ˆæ›´æ–°
                for (let i = this.bombs.length - 1; i >= 0; i--) {
                    let b = this.bombs[i];
                    b.vy += GRAVITY * 0.4 * dt; // ç‚¸å½ˆæ‰è½é€Ÿåº¦æ…¢ä¸€é»
                    b.y += b.vy * dt;

                    // æª¢æŸ¥ç‚¸å½ˆèˆ‡ç©å®¶ç¢°æ’
                    if (this.isColliding(this.player, b)) {
                        audio.hurt();
                        this.createParticles(b.x, b.y, '#EF4444');
                        this.updateHealth(-MAX_HEALTH); // ç›´æ¥æ­¸é›¶
                        this.bombs.splice(i, 1);
                        continue;
                    }

                    // è¶…å‡ºç•«é¢å‰‡ç§»é™¤
                    if (b.y > 600) {
                        this.bombs.splice(i, 1);
                    }
                }

                // æ”å½±æ©Ÿè·Ÿéš¨
                if (this.player.x > this.camera.x + 300) {
                    this.camera.x = this.player.x - 300;
                }

                // å‹•æ…‹ç”Ÿæˆé—œå¡
                this.generateLevelChunks(this.camera.x + 1200);

                // ç”Ÿæˆçµ‚é»æ——å­æ¢ä»¶ï¼šè¶…é100åˆ†
                if (this.player.score >= 100 && !this.flagSpawned) {
                    this.flagSpawned = true;
                    // ç”Ÿæˆåœ¨å‰æ–¹ä¸€æ®µè·é›¢çš„å¹³å°ä¸Š
                    let flagX = this.player.x + 800;
                    this.platforms.push({ x: flagX - 50, y: 480, w: 200, h: 60 });
                    this.entities.push({ type: 'flag', x: flagX, y: 180, w: 40, h: 300, flagY: 410, state: 'idle' });
                    // UI æç¤º
                    document.getElementById('ui-goal').innerHTML = "<span class='text-green-400 animate-pulse'>çµ‚é»å·²å‡ºç¾ï¼å¿«è¡ï¼</span>";
                }

                // --- å‹åˆ©å‹•ç•«èˆ‡ç…™ç«é‚è¼¯ ---
                let flag = this.entities.find(e => e.type === 'flag');
                if (this.state === 'win_anim' && flag) {
                    if (flag.state === 'raising') {
                        flag.flagY -= 150 * dt; // æ——å­ä¸Šå‡
                        if (flag.flagY <= flag.y + 15) {
                            flag.flagY = flag.y + 15;
                            flag.state = 'fireworks';
                            this.winTimer = 3.5; // ç…™ç«æ–½æ”¾ 3.5 ç§’
                        }
                    } else if (flag.state === 'fireworks') {
                        this.winTimer -= dt;
                        if (Math.random() < 0.15) {
                            this.createFirework(
                                this.camera.x + canvas.width/2 + (Math.random() - 0.5) * 500,
                                50 + Math.random() * 250
                            );
                        }
                        if (this.winTimer <= 0) {
                            this.gameOver(true, "æˆåŠŸæŠµé”çµ‚é»ï¼");
                            return;
                        }
                    }
                }

                // --- æ›´æ–°å¯¦é«”èˆ‡ç¢°æ’ ---
                for (let i = this.entities.length - 1; i >= 0; i--) {
                    let ent = this.entities[i];
                    
                    // æ€ªç‰©ç§»å‹•
                    if (ent.type === 'monster') {
                        ent.x += ent.vx * dt;
                        // ç°¡å–®çš„å·¦å³å·¡é‚ (é‡åˆ°é‚Šç•Œæˆ–èµ°é å°±åè½‰)
                        if (Math.random() < 0.01) ent.vx *= -1; 
                    }

                    // æª¢æŸ¥ç©å®¶èˆ‡å¯¦é«”ç¢°æ’
                    if (this.isColliding(this.player, ent)) {
                        if (ent.type === 'fruit') {
                            audio.eatFruit();
                            this.updateHealth(10);
                            this.updateScore(30);
                            this.createParticles(ent.x, ent.y, '#34D399');
                            this.entities.splice(i, 1);
                        } else if (ent.type === 'gun') {
                            audio.getGun();
                            this.player.ammo += 20;
                            this.updateScore(10);
                            this.createParticles(ent.x, ent.y, '#60A5FA');
                            this.entities.splice(i, 1);
                        } else if (ent.type === 'broom') {
                            audio.getGun(); // å€Ÿç”¨ç²å¾—ç‰©å“éŸ³æ•ˆ
                            this.player.isFlying = true;
                            this.player.flyTimer = 10; // é£›è¡Œ 10 ç§’
                            this.createParticles(ent.x, ent.y, '#FBBF24');
                            this.entities.splice(i, 1);
                        } else if (ent.type === 'junk') {
                            audio.hurt();
                            this.updateHealth(-5);
                            this.updateScore(-15);
                            this.createParticles(ent.x, ent.y, '#F87171');
                            this.entities.splice(i, 1);
                            // åŠ ä¸Šæ“Šé€€æ•ˆæœ
                            this.player.vx = -300; this.player.vy = -300;
                        } else if (ent.type === 'monster') {
                            audio.hurt();
                            this.updateHealth(-10);
                            this.updateScore(-20);
                            this.createParticles(ent.x, ent.y, '#A78BFA');
                            this.entities.splice(i, 1);
                            this.player.vx = -400; this.player.vy = -300;
                        } else if (ent.type === 'flag' && this.state === 'playing') {
                            this.state = 'win_anim';
                            ent.state = 'raising';
                            this.player.x = ent.x - this.player.width; // è®“ä¸»è§’åœåœ¨æ——æ†å‰
                        }
                    }
                }

                // --- å­å½ˆæ›´æ–°èˆ‡ç¢°æ’ ---
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    let b = this.bullets[i];
                    b.x += b.vx * dt;
                    
                    // ç§»é™¤è¶…å‡ºç•«é¢çš„å­å½ˆ
                    if (b.x > this.camera.x + 1000 || b.x < this.camera.x - 100) {
                        this.bullets.splice(i, 1);
                        continue;
                    }

                    // å­å½ˆæ‰“æ“Šå¯¦é«”
                    let hit = false;
                    for (let j = this.entities.length - 1; j >= 0; j--) {
                        let ent = this.entities[j];
                        if ((ent.type === 'junk' || ent.type === 'monster') && this.isColliding(b, ent)) {
                            audio.hitEnemy();
                            ent.hp--;
                            this.createParticles(b.x, b.y, '#FBBF24');
                            if (ent.hp <= 0) {
                                this.entities.splice(j, 1);
                            }
                            this.bullets.splice(i, 1);
                            hit = true;
                            break;
                        }
                    }
                    // å­å½ˆæ‰“åˆ°ç‰† (ç•¥éï¼Œç‚ºä¿æŒç°¡å–®)
                }

                // --- ç²’å­æ›´æ–° ---
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    let p = this.particles[i];
                    p.x += p.vx * dt;
                    p.y += p.vy * dt;
                    
                    if (p.type === 'firework') {
                        p.vy += GRAVITY * 0.1 * dt; // ç…™ç«äº›å¾®å—åˆ°é‡åŠ›å½±éŸ¿
                        p.life -= dt * 0.8;
                    } else {
                        p.life -= dt * 2;
                    }
                    
                    if (p.life <= 0) this.particles.splice(i, 1);
                }

                this.updateUI();
                this.draw(timestamp);

                requestAnimationFrame((t) => this.loop(t));
            }

            isColliding(rect1, rect2) {
                // å…¼å®¹ width/height èˆ‡ w/h å…©ç¨®å±¬æ€§å‘½åæ–¹å¼
                const w1 = rect1.width || rect1.w;
                const h1 = rect1.height || rect1.h;
                const w2 = rect2.width || rect2.w;
                const h2 = rect2.height || rect2.h;

                return rect1.x < rect2.x + w2 &&
                       rect1.x + w1 > rect2.x &&
                       rect1.y < rect2.y + h2 &&
                       rect1.y + h1 > rect2.y;
            }

            draw(timestamp = performance.now()) {
                // æ¸…é™¤èƒŒæ™¯ (ç•«å¸ƒå¤§å°)
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // --- 2. é æ™¯ï¼šé›²æœµ (è¦–å·® 0.1) ---
                ctx.save();
                ctx.translate(-this.camera.x * 0.1, 0);
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                for(let i=0; i<30; i++) {
                    let cx = (i * 300);
                    let cy = 80 + (i % 5) * 30;
                    ctx.beginPath();
                    ctx.arc(cx, cy, 40, 0, Math.PI*2);
                    ctx.arc(cx+40, cy, 50, 0, Math.PI*2);
                    ctx.arc(cx+80, cy, 40, 0, Math.PI*2);
                    ctx.fill();
                }
                ctx.restore();

                // --- 3. èƒŒæ™¯ï¼šé«˜å±± (è¦–å·® 0.2) ---
                ctx.save();
                ctx.translate(-this.camera.x * 0.2, 0);
                ctx.fillStyle = '#658B6F'; // é å±±é¡è‰² (åè—ç¶ )
                ctx.beginPath();
                ctx.moveTo(-500, canvas.height);
                for(let i=-2; i<50; i++) {
                    let mx = i * 400;
                    let my = 180 + Math.abs(Math.sin(i * 13.5)) * 150; 
                    ctx.lineTo(mx, my);
                    ctx.lineTo(mx + 200, canvas.height);
                }
                ctx.fill();
                ctx.restore();

                // --- 4. èƒŒæ™¯ï¼šç€‘å¸ƒèˆ‡è¿‘å±± (è¦–å·® 0.3) ---
                ctx.save();
                ctx.translate(-this.camera.x * 0.3, 0);
                for(let i=-1; i<40; i++) {
                    let wx = i * 600 + 300;
                    let wy = 220 + Math.sin(i * 7) * 80;
                    
                    // ç•«ä¸€åº§è¿‘å±±ä¾†è¥¯æ‰˜ç€‘å¸ƒ
                    ctx.fillStyle = '#4A6B53'; // è¿‘å±±é¡è‰² (è¼ƒæ·±ç¶ )
                    ctx.beginPath();
                    ctx.moveTo(wx - 200, canvas.height);
                    ctx.lineTo(wx + 30, wy - 20); // å±±é ‚
                    ctx.lineTo(wx + 250, canvas.height);
                    ctx.fill();

                    // ç•«ç€‘å¸ƒ (ä¸€åŠçš„å±±æœ‰ç€‘å¸ƒ)
                    if (i % 2 === 0) { 
                        ctx.fillStyle = '#87CEFA'; // ç€‘å¸ƒæ°´è‰²
                        ctx.fillRect(wx, wy, 60, canvas.height - wy);
                        
                        // ç€‘å¸ƒå‹•æ…‹æ°´èŠ±
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                        let h = canvas.height - wy;
                        let foamY1 = wy + ((timestamp * 0.15) % h);
                        let foamY2 = wy + ((timestamp * 0.2 + 100) % h);
                        let foamY3 = wy + ((timestamp * 0.1 + 50) % h);
                        ctx.fillRect(wx + 10, foamY1, 4, 40);
                        ctx.fillRect(wx + 30, foamY2, 6, 60);
                        ctx.fillRect(wx + 45, foamY3, 4, 30);
                    }
                }
                ctx.restore();

                // --- 5. ä¸­æ™¯ï¼šé‡å¤–å¢æ— (è¦–å·® 0.5) ---
                ctx.save();
                ctx.translate(-this.camera.x * 0.5, 0);
                for(let i=-2; i<60; i++) {
                    let tx = i * 200 + (Math.sin(i * 11) * 100);
                    let ty = 320 + (Math.cos(i * 5) * 40);
                    
                    // æ¨¹å¹¹
                    ctx.fillStyle = '#5C4033';
                    ctx.fillRect(tx + 40, ty, 20, canvas.height - ty);
                    
                    // æ¨¹å†  (ç†±å¸¶å¢æ—æ„Ÿè¦º)
                    ctx.fillStyle = '#228B22';
                    ctx.beginPath();
                    ctx.arc(tx + 50, ty + 10, 60, 0, Math.PI*2);
                    ctx.arc(tx + 10, ty + 40, 50, 0, Math.PI*2);
                    ctx.arc(tx + 90, ty + 40, 50, 0, Math.PI*2);
                    ctx.fill();
                    
                    // å¢åŠ æ·±è‰²è‘‰ç‰‡å±¤æ¬¡
                    ctx.fillStyle = '#006400';
                    ctx.beginPath();
                    ctx.arc(tx + 50, ty + 50, 40, 0, Math.PI*2);
                    ctx.fill();
                }
                ctx.restore();

                // --- 6. å‰æ™¯ï¼šéŠæˆ²å¯¦é«”èˆ‡å¹³å° (è¦–å·® 1.0) ---
                ctx.save();
                // æ‡‰ç”¨æ”å½±æ©Ÿä½ç§»
                ctx.translate(-this.camera.x, 0);

                // ç•«å¹³å° (ç¶ è‰²è‰åœ°ï¼Œæ£•è‰²æ³¥åœŸ)
                for (let plat of this.platforms) {
                    // å¦‚æœåœ¨ç•«é¢å¤–å¤ªå¤šå°±ä¸ç•«
                    if (plat.x + plat.w < this.camera.x || plat.x > this.camera.x + canvas.width) continue;
                    
                    ctx.fillStyle = '#8B4513'; // æ³¥åœŸ
                    ctx.fillRect(plat.x, plat.y, plat.w, plat.h);
                    ctx.fillStyle = '#32CD32'; // è‰åœ°
                    ctx.fillRect(plat.x, plat.y, plat.w, 8);
                }

                // ç•«å¯¦é«” (Emoji)
                ctx.font = '30px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                for (let ent of this.entities) {
                    if (ent.x + ent.w < this.camera.x || ent.x > this.camera.x + canvas.width) continue;
                    
                    if (ent.type === 'flag') {
                        // ç•«æ——æ¡¿
                        ctx.fillStyle = '#D1D5DB';
                        ctx.fillRect(ent.x + 15, ent.y, 10, ent.h);
                        
                        // ç•«æ——æ¡¿é ‚ç«¯é‡‘çƒ
                        ctx.fillStyle = '#FBBF24';
                        ctx.beginPath();
                        ctx.arc(ent.x + 20, ent.y, 12, 0, Math.PI * 2);
                        ctx.fill();

                        // ç•«ç´…æ——å­ (æ”¾å¤§ä¸¦åŠ ä¸Šã€Œæ±å¯¶ã€å­—æ¨£)
                        ctx.fillStyle = '#EF4444';
                        ctx.beginPath();
                        ctx.moveTo(ent.x + 25, ent.flagY);
                        ctx.lineTo(ent.x + 135, ent.flagY + 10);
                        ctx.lineTo(ent.x + 120, ent.flagY + 35);
                        ctx.lineTo(ent.x + 135, ent.flagY + 60);
                        ctx.lineTo(ent.x + 25, ent.flagY + 70);
                        ctx.fill();

                        // å¯«ä¸Šã€Œæ±å¯¶ã€
                        ctx.save();
                        ctx.fillStyle = '#FFFFFF';
                        ctx.font = '900 30px "ZCOOL KuaiLe", "Noto Sans TC", sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.shadowColor = 'rgba(0,0,0,0.6)';
                        ctx.shadowBlur = 4;
                        ctx.shadowOffsetX = 2;
                        ctx.shadowOffsetY = 2;
                        ctx.translate(ent.x + 75, ent.flagY + 35);
                        ctx.rotate(0.05); // é…åˆæ——å­çš„ç¨å¾®å‚¾æ–œ
                        ctx.fillText('æ±å¯¶', 0, 0);
                        ctx.restore();
                        continue;
                    }
                    else if (ent.type === 'monster') ctx.font = '45px Arial';
                    else ctx.font = '30px Arial';

                    ctx.fillText(ent.emoji, ent.x + ent.w/2, ent.y + ent.h/2);

                    // ç•«è¡€æ¢ (æ€ªç‰©å’Œåƒåœ¾é£Ÿç‰©)
                    if (ent.hp !== undefined) {
                        ctx.fillStyle = 'red'; // è¡€æ¢åº•è‰²
                        let maxHp = ent.type === 'monster' ? 5 : 3;
                        let hpBarW = 30;
                        // ç•«èƒŒæ™¯ç´…æ¢
                        ctx.fillRect(ent.x + (ent.w-hpBarW)/2, ent.y - 10, hpBarW, 4);
                        // ç•«å‰©é¤˜ç¶ æ¢
                        ctx.fillStyle = '#10B981'; 
                        ctx.fillRect(ent.x + (ent.w-hpBarW)/2, ent.y - 10, hpBarW * (ent.hp/maxHp), 4);
                    }
                }

                // ç•«ç©å®¶ (Qç‰ˆå°å°é­”æ³•å¸«)
                let state = 'idle';
                if (this.player.isFlying) state = 'fly';
                else if (timestamp - this.player.lastShootTime < 200) state = 'shoot';
                else if (!this.player.isGrounded) state = 'jump';
                else if (Math.abs(this.player.vx) > 0) state = 'run';

                ctx.save();
                ctx.translate(this.player.x + this.player.width / 2, this.player.y + this.player.height);
                ctx.scale(this.player.dir, 1); // ä¾æ“šé¢å‘ç¿»è½‰

                let bounce = 0, legAngle1 = 0, legAngle2 = 0, armAngle = 0;
                if (state === 'run') {
                    bounce = Math.abs(Math.sin(timestamp * 0.015)) * 4;
                    legAngle1 = Math.sin(timestamp * 0.015) * 35;
                    legAngle2 = -Math.sin(timestamp * 0.015) * 35;
                    armAngle = Math.sin(timestamp * 0.015) * 20;
                } else if (state === 'jump') {
                    legAngle1 = -30;
                    legAngle2 = 20;
                    armAngle = -45;
                    bounce = 5; // è·³èºæ™‚èº«é«”ç¨å¾®æ‹‰é•·
                } else if (state === 'fly') {
                    legAngle1 = 45;
                    legAngle2 = 60;
                    armAngle = -20;
                    bounce = Math.sin(timestamp * 0.01) * 4; // é£„æµ®æ„Ÿ
                } else if (state === 'shoot') {
                    armAngle = -80;
                }

                // ç•«é­”æ³•æƒæŠŠ (è¦åœ¨è…³çš„åº•å±¤)
                if (state === 'fly') {
                    // æƒæŠŠæŸ„
                    ctx.fillStyle = '#78350F';
                    ctx.beginPath();
                    if (ctx.roundRect) ctx.roundRect(-25, -12 - bounce, 55, 6, 3);
                    else ctx.fillRect(-25, -12 - bounce, 55, 6);
                    ctx.fill();

                    // æƒæŠŠå°¾å·´
                    ctx.fillStyle = '#D97706';
                    ctx.beginPath();
                    ctx.moveTo(-20, -12 - bounce);
                    ctx.lineTo(-45, -22 - bounce);
                    ctx.lineTo(-50, -9 - bounce);
                    ctx.lineTo(-45, 3 - bounce);
                    ctx.lineTo(-20, -6 - bounce);
                    ctx.fill();
                    
                    // æƒæŠŠä¸Šçš„æ˜Ÿæ˜Ÿé–ƒçˆ
                    ctx.fillStyle = '#FDE047';
                    ctx.beginPath(); ctx.arc(28, -9 - bounce, 3, 0, Math.PI*2); ctx.fill();
                }

                // æŠ«é¢¨ (æ˜äº®çš„æ«»æ¡ƒç²‰)
                ctx.fillStyle = '#FB7185';
                ctx.beginPath();
                ctx.moveTo(-10, -35 - bounce);
                let capeFlow = state === 'run' ? Math.sin(timestamp * 0.02) * 8 : 
                              (state === 'jump' ? 15 : 
                              (state === 'fly' ? 20 + Math.sin(timestamp * 0.05) * 5 : 0));
                ctx.lineTo(-25 - capeFlow, -8 - bounce);
                ctx.lineTo(-8, -8 - bounce);
                ctx.fill();

                // è…³ (åœ“æ½¤çš„æ£•è‰²å°é‹å­)
                ctx.fillStyle = '#78350F';
                ctx.save(); ctx.rotate(legAngle2 * Math.PI / 180); 
                ctx.beginPath(); ctx.ellipse(-5, -8, 5, 8, 0, 0, Math.PI*2); ctx.fill(); ctx.restore();
                ctx.save(); ctx.rotate(legAngle1 * Math.PI / 180); 
                ctx.beginPath(); ctx.ellipse(5, -8, 5, 8, 0, 0, Math.PI*2); ctx.fill(); ctx.restore();

                // èº«é«”é•·è¢ (å¤©ç©ºè—)
                ctx.fillStyle = '#60A5FA';
                ctx.beginPath();
                ctx.moveTo(-15, -12 - bounce);
                ctx.lineTo(15, -12 - bounce);
                ctx.lineTo(12, -35 - bounce);
                ctx.lineTo(-12, -35 - bounce);
                ctx.fill();

                // è‡‰éƒ¨ (è¶…å¯æ„›Qç‰ˆæ‰åœ“å¤§é ­)
                ctx.fillStyle = '#FFE4E1';
                ctx.beginPath();
                if (ctx.ellipse) {
                    ctx.ellipse(0, -42 - bounce, 18, 16, 0, 0, Math.PI * 2);
                } else {
                    ctx.arc(0, -42 - bounce, 17, 0, Math.PI * 2);
                }
                ctx.fill();

                // çœ¼ç› (å¤§å¤§çš„é–ƒäº®é»‘çœ¼ç )
                ctx.fillStyle = '#000';
                if (ctx.ellipse) {
                    ctx.beginPath(); ctx.ellipse(6, -42 - bounce, 2.5, 3.5, 0, 0, Math.PI * 2); ctx.fill();
                    ctx.beginPath(); ctx.ellipse(14, -42 - bounce, 2.5, 3.5, 0, 0, Math.PI * 2); ctx.fill();
                } else {
                    ctx.beginPath(); ctx.arc(6, -42 - bounce, 3, 0, Math.PI * 2); ctx.fill();
                    ctx.beginPath(); ctx.arc(14, -42 - bounce, 3, 0, Math.PI * 2); ctx.fill();
                }
                
                // çœ¼ç›é«˜å…‰
                ctx.fillStyle = '#FFF';
                ctx.beginPath(); ctx.arc(6.5, -43 - bounce, 1, 0, Math.PI * 2); ctx.fill();
                ctx.beginPath(); ctx.arc(14.5, -43 - bounce, 1, 0, Math.PI * 2); ctx.fill();
                
                // è…®ç´… (ç²‰å«©å¤§ç‰‡)
                ctx.fillStyle = 'rgba(255, 105, 180, 0.4)';
                if (ctx.ellipse) {
                    ctx.beginPath(); ctx.ellipse(2, -37 - bounce, 4, 2.5, 0, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.ellipse(16, -37 - bounce, 4, 2.5, 0, 0, Math.PI*2); ctx.fill();
                } else {
                    ctx.beginPath(); ctx.arc(2, -37 - bounce, 3, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(16, -37 - bounce, 3, 0, Math.PI*2); ctx.fill();
                }

                // å˜´å·´ (å°å°çš„å¾®ç¬‘)
                ctx.strokeStyle = '#D97706';
                ctx.lineWidth = 1.5;
                ctx.beginPath(); ctx.arc(10, -38 - bounce, 2, 0, Math.PI); ctx.stroke();

                // é­”æ³•å¸½ (ç¶“å…¸çš„è—è‰²å¤§å·«å¸«å¸½ï¼Œå¸½å°–å‘å¾Œå‚)
                ctx.fillStyle = '#3B82F6';
                ctx.beginPath();
                ctx.moveTo(-24, -54 - bounce); // å¸½æ²¿
                ctx.lineTo(24, -54 - bounce);
                ctx.lineTo(10, -68 - bounce);
                ctx.lineTo(-10, -90 - bounce); // å¸½å°–å‘å¾Œå½
                ctx.lineTo(-6, -68 - bounce);
                ctx.fill();
                
                // å¸½æ²¿é»ƒè‰²è£é£¾å¸¶
                ctx.strokeStyle = '#FBBF24';
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                ctx.beginPath(); ctx.moveTo(-20, -56 - bounce); ctx.lineTo(20, -56 - bounce); ctx.stroke();

                // æ‰‹è‡‚èˆ‡é­”æ–
                ctx.save();
                ctx.translate(0, -30 - bounce);
                ctx.rotate(armAngle * Math.PI / 180);
                
                // æ‰‹è‡‚
                ctx.fillStyle = '#60A5FA';
                if (ctx.roundRect) {
                    ctx.beginPath(); ctx.roundRect(-4, 0, 8, 14, 4); ctx.fill();
                } else {
                    ctx.fillRect(-4, 0, 8, 14);
                }
                
                // å°æ‰‹
                ctx.fillStyle = '#FFE4E1';
                ctx.beginPath(); ctx.arc(0, 14, 4, 0, Math.PI * 2); ctx.fill();
                
                // é­”æ– (ç¶“å…¸æœ¨è‰²åº•åº§)
                ctx.fillStyle = '#D97706';
                ctx.fillRect(-2, 4, 4, -30);
                
                // é­”æ³•æ˜Ÿæ˜Ÿ (Qç‰ˆå¤§æ˜Ÿæ˜Ÿ)
                ctx.fillStyle = '#FEF08A';
                ctx.beginPath();
                let starScale = state === 'shoot' ? 1.5 + Math.random() * 0.5 : 1;
                ctx.arc(0, -26, 7 * starScale, 0, Math.PI * 2);
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#FDE047';
                ctx.fill();
                ctx.restore();

                ctx.restore();

                // ç•«å­å½ˆ
                ctx.fillStyle = '#FBBF24';
                for (let b of this.bullets) {
                    ctx.fillRect(b.x, b.y, b.w, b.h);
                }

                // ç•«å¤©ä½¿
                ctx.font = '50px Arial';
                for (let angel of this.angels) {
                    ctx.fillText(angel.emoji, angel.x + 25, angel.y + 25);
                }

                // ç•«é£›ç¢Ÿèˆ‡ç‚¸å½ˆ
                ctx.font = '60px Arial';
                for (let ufo of this.ufos) {
                    ctx.fillText('ğŸ›¸', ufo.x + 30, ufo.y + 20);
                }
                
                ctx.font = '35px Arial';
                for (let b of this.bombs) {
                    ctx.fillText(b.emoji, b.x + b.w/2, b.y + b.h/2);
                }

                // ç•«æ‰è½çš„æ°´æœ (ä¾†è‡ªå¤©ä½¿)
                ctx.font = '30px Arial';
                for (let f of this.fallingFruits) {
                    ctx.fillText(f.emoji, f.x + f.w/2, f.y + f.h/2);
                }

                // ç•«ç²’å­
                for (let p of this.particles) {
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = Math.max(0, Math.min(1, p.life)); // åŠ å…¥æ¼¸éš±æ•ˆæœ
                    
                    if (p.type === 'firework') {
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.w/2, 0, Math.PI*2);
                        ctx.fill();
                        ctx.shadowBlur = 10;
                        ctx.shadowColor = p.color;
                    } else {
                        ctx.fillRect(p.x, p.y, p.w, p.h);
                    }
                    ctx.shadowBlur = 0; // é‡ç½®é™°å½±
                }
                ctx.globalAlpha = 1;

                ctx.restore();
            }

            updateUI() {
                // æ›´æ–°ç”Ÿå‘½æ¢
                const healthPercent = Math.max(0, (this.player.health / MAX_HEALTH) * 100);
                const healthBar = document.getElementById('ui-health-bar');
                if(healthBar) {
                    healthBar.style.width = healthPercent + '%';
                    if (healthPercent > 50) {
                        healthBar.className = "h-full bg-green-500 transition-all duration-300";
                    } else if (healthPercent > 20) {
                        healthBar.className = "h-full bg-yellow-400 transition-all duration-300";
                    } else {
                        healthBar.className = "h-full bg-red-500 transition-all duration-300";
                    }
                }
                
                const healthText = document.getElementById('ui-health-text');
                if(healthText) healthText.innerText = `${this.player.health}/${MAX_HEALTH}`;

                document.getElementById('ui-score').innerText = this.player.score;
                document.getElementById('ui-ammo').innerText = this.player.ammo;
                document.getElementById('ui-time').innerText = this.timeLeft;

                // æ›´æ–°é£›è¡Œ UI ç‹€æ…‹
                const flyContainer = document.getElementById('ui-fly-container');
                if (this.player.isFlying) {
                    flyContainer.classList.remove('hidden');
                    document.getElementById('ui-fly-time').innerText = Math.ceil(this.player.flyTimer);
                } else {
                    flyContainer.classList.add('hidden');
                }
            }

            gameOver(isWin, msg) {
                this.state = isWin ? 'win' : 'lose';
                this.cleanup();
                
                if (isWin) {
                    audio.win();
                    document.getElementById('end-title').className = "text-5xl font-black mb-2 text-center text-green-400";
                    document.getElementById('end-title').innerText = "æ­å–œéé—œï¼";
                    // å‹åˆ©é¡å¤–åŠ æ™‚é–“åˆ†æ•¸
                    this.player.score += this.timeLeft;
                    msg += `<br>å‰©é¤˜æ™‚é–“åŠ åˆ†: ${this.timeLeft} = ç¸½åˆ†: <span class="text-yellow-400 font-bold">${this.player.score}</span>`;
                } else {
                    audio.lose();
                    document.getElementById('end-title').className = "text-5xl font-black mb-2 text-center text-red-500";
                    document.getElementById('end-title').innerText = "éŠæˆ²çµæŸ";
                    msg += `<br>æœ€çµ‚å¾—åˆ†: <span class="text-yellow-400 font-bold">${this.player.score}</span>`;
                }
                
                document.getElementById('end-msg').innerHTML = msg;
                
                // å„²å­˜ä¸¦é¡¯ç¤ºæ’è¡Œæ¦œ
                Leaderboard.save(this.playerName, this.player.score);
                document.getElementById('leaderboard').innerHTML = Leaderboard.getHTML();

                uiLayer.classList.add('hidden');
                mobileControls.classList.add('hidden');
                endScreen.classList.remove('hidden');
            }
        }

        // --- éŠæˆ²æµç¨‹æ§åˆ¶ ---
        let currentGame = null;

        document.getElementById('start-btn').addEventListener('click', () => {
            const nameInput = document.getElementById('player-name').value.trim() || 'å‹‡è€…';
            audio.init(); // å¿…é ˆåœ¨ä½¿ç”¨è€…é»æ“Šå¾Œåˆå§‹åŒ–éŸ³æ•ˆ
            
            startScreen.classList.add('hidden');
            uiLayer.classList.remove('hidden');
            if (window.innerWidth < 768) mobileControls.classList.remove('hidden'); // æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºæ§åˆ¶
            
            // é‡ç½® UI ç›®æ¨™æ–‡å­—
            document.getElementById('ui-goal').innerHTML = "ç›®æ¨™: 100åˆ†é–‹å•Ÿçµ‚é»";

            currentGame = new Game(nameInput);
        });

        document.getElementById('restart-btn').addEventListener('click', () => {
            endScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        });

        // é é˜²ç©ºç™½éµæ»¾å‹•ç¶²é 
        window.addEventListener('keydown', function(e) {
            if(e.keyCode == 32 && e.target == document.body) {
                e.preventDefault();
            }
        });

        // é¦–æ¬¡è¼‰å…¥é¡¯ç¤ºæ’è¡Œæ¦œ
        document.getElementById('leaderboard').innerHTML = Leaderboard.getHTML();

    </script>
</body>
</html>
